name: Production Smoke Tests

on:
  # Run after successful deployments
  workflow_run:
    workflows: ["Build and Deploy Services"]
    types:
      - completed
    branches:
      - main
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter (e.g., TestSectionURLExtraction)'
        required: false
        default: ''

jobs:
  smoke-tests:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    # Only run if deployment succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials mizzou-news-gke \
            --region us-central1
      
      - name: Wait for deployments to be ready
        run: |
          echo "â³ Verifying deployments are healthy and ready..."
          echo ""
          
          TIMEOUT=600  # 10 minutes
          SERVICES=(mizzou-api mizzou-processor mizzou-crawler)
          
          for service in "${SERVICES[@]}"; do
            echo "Checking $service deployment..."
            if ! kubectl rollout status deployment/$service -n production --timeout=${TIMEOUT}s; then
              echo "âŒ $service deployment failed to become ready"
              echo ""
              echo "Pod status:"
              kubectl get pods -n production -l app=$service
              echo ""
              echo "Recent pod events:"
              kubectl describe pods -n production -l app=$service | grep -A 20 "Events:"
              exit 1
            fi
            echo "âœ… $service is ready"
          done
          
          echo ""
          echo "â³ Waiting additional 30 seconds for service stabilization..."
          sleep 30
          
          # Verify no pods are in CrashLoopBackOff
          echo ""
          echo "Verifying pod health..."
          CRASH_PODS=$(kubectl get pods -n production \
            -o jsonpath='{range .items[*]}{.metadata.name},{.status.containerStatuses[*].state.waiting.reason}{"\n"}{end}' | \
            grep CrashLoopBackOff | wc -l)
          
          if [ "$CRASH_PODS" -gt 0 ]; then
            echo "âŒ Found pods in CrashLoopBackOff state"
            kubectl get pods -n production -o wide
            exit 1
          fi
          
          echo "âœ… All pods are healthy"
      
      - name: Run smoke tests
        id: smoke_tests
        run: |
          echo "ðŸ§ª Running production smoke tests..."
          echo ""
          
          # Get processor pod
          POD_NAME=$(kubectl get pods -n production -l app=mizzou-processor -o jsonpath='{.items[0].metadata.name}')
          
          if [ -z "$POD_NAME" ]; then
            echo "âŒ No processor pod found"
            kubectl get pods -n production
            exit 1
          fi
          
          echo "Using pod: $POD_NAME"
          
          # Verify pod is actually running (not just ready)
          POD_STATUS=$(kubectl get pod "$POD_NAME" -n production -o jsonpath='{.status.phase}')
          if [ "$POD_STATUS" != "Running" ]; then
            echo "âŒ Pod is in state: $POD_STATUS (expected Running)"
            kubectl describe pod "$POD_NAME" -n production
            exit 1
          fi
          
          # Quick connectivity check
          echo "Checking pod connectivity..."
          if ! kubectl exec -n production "$POD_NAME" -- bash -c "echo 'OK'"; then
            echo "âŒ Pod is not responding to commands"
            exit 1
          fi
          echo "âœ… Pod is responding"
          
          echo ""
          echo "Running test suite..."
          
          # Build pytest command
          PYTEST_CMD="pytest tests/e2e/test_production_smoke.py -v --tb=short --color=yes"
          
          # Add test filter if provided
          if [ -n "${{ github.event.inputs.test_filter }}" ]; then
            PYTEST_CMD="$PYTEST_CMD -k ${{ github.event.inputs.test_filter }}"
          fi
          
          # Run tests with timeout
          timeout 600 kubectl exec -n production "$POD_NAME" -- bash -c "$PYTEST_CMD"
          TEST_RESULT=$?
          
          if [ $TEST_RESULT -eq 124 ]; then
            echo "âŒ Tests timed out after 10 minutes"
            exit 1
          elif [ $TEST_RESULT -ne 0 ]; then
            echo "âŒ Tests failed with exit code $TEST_RESULT"
            exit 1
          fi
      
      - name: Report results
        if: always()
        run: |
          if [ "${{ steps.smoke_tests.outcome }}" == "success" ]; then
            echo "âœ… All smoke tests passed!"
          else
            echo "âŒ Smoke tests failed!"
            echo "Check the logs above for details."
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_body = `## ðŸš¨ Production Smoke Tests Failed
            
            The E2E smoke tests failed after deployment to production.
            
            **Workflow:** ${context.workflow}
            **Run:** ${context.runId}
            **Commit:** ${context.sha}
            
            ### Action Required
            - Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details
            - Verify production services are functioning correctly
            - Consider rollback if critical functionality is broken
            
            ### Quick Checks
            \`\`\`bash
            # Check recent extractions
            kubectl exec -n production deployment/mizzou-processor -- python -c "
            from src.models.database import DatabaseManager
            from sqlalchemy import text
            db = DatabaseManager()
            with db.get_session() as session:
                result = session.execute(text('SELECT COUNT(*) FROM articles WHERE extracted_at >= NOW() - INTERVAL \\'1 hour\\')).scalar()
                print(f'Articles extracted in last hour: {result}')
            "
            
            # Check pod logs
            kubectl logs -n production -l app=mizzou-processor --tail=100 | grep -i error
            \`\`\`
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production smoke tests failed - ${new Date().toISOString().split('T')[0]}`,
              body: issue_body,
              labels: ['bug', 'production', 'urgent']
            });
