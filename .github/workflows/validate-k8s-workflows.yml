name: Validate K8s Workflows

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'k8s/argo/**/*.yaml'
      - 'k8s/**/*.yaml'
  workflow_dispatch: {}
  # Removed push to main - redundant since validation already runs on PR

jobs:
  validate-sql-queries:
    runs-on: ubuntu-latest
    name: Validate SQL in Argo Workflows
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install sqlparse pyyaml sqlalchemy psycopg2-binary
      
      - name: Extract and validate SQL from workflows
        run: |
          python - <<'EOF'
          import yaml
          import re
          import sqlparse
          from pathlib import Path
          import sys
          
          errors = []
          
          # Known PostgreSQL table schemas
          SCHEMAS = {
              'candidate_links': {
                  'id', 'url', 'source', 'discovered_at', 'crawl_depth', 
                  'discovered_by', 'status', 'fetched_at', 'http_status',
                  'content_hash', 'meta', 'publish_date', 'source_host_id',
                  'created_at', 'dataset_id', 'source_id'
              },
              'articles': {
                  'id', 'candidate_link_id', 'url', 'title', 'author',
                  'publish_date', 'content', 'text', 'text_hash', 'text_excerpt',
                  'status', 'metadata', 'wire', 'created_at', 'raw_gcs_path',
                  'extracted_at', 'extraction_version'
              },
              'extraction_telemetry_v2': {
                  'id', 'article_id', 'operation_id', 'url', 'status',
                  'started_at', 'completed_at', 'duration_ms', 'error_message'
              }
          }
          
          # Find all YAML files in k8s/argo/
          for yaml_file in Path('k8s/argo').glob('**/*.yaml'):
              print(f"\nChecking {yaml_file}...")
              
              with open(yaml_file) as f:
                  content = f.read()
              
              # Extract SQL queries from the file
              sql_queries = re.findall(r'SELECT.*?(?="""|\'\'\')|\s+FROM\s+(\w+)', content, re.DOTALL | re.IGNORECASE)
              
              # Check for common column name errors
              if 'article_id' in content and 'candidate_links' in content:
                  # Check if we're referencing article_id from candidate_links
                  if re.search(r'candidate_links.*article_id', content, re.IGNORECASE | re.DOTALL):
                      errors.append(f"{yaml_file}: candidate_links table does not have 'article_id' column")
              
              # Check for invalid CLI arguments
              if '--exhaust-queue' in content:
                  errors.append(f"{yaml_file}: Invalid flag '--exhaust-queue'. Use '--no-exhaust-queue' to disable or omit (default is True)")
              
              # Look for table references and validate columns
              for table_name in SCHEMAS.keys():
                  if table_name in content:
                      # Find column references for this table
                      pattern = rf'{table_name}\.(\w+)'
                      matches = re.findall(pattern, content)
                      for col in matches:
                          if col not in SCHEMAS[table_name]:
                              errors.append(f"{yaml_file}: Column '{col}' does not exist in table '{table_name}'")
          
          if errors:
              print("\n❌ VALIDATION ERRORS FOUND:\n")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)
          else:
              print("\n✅ All SQL queries validated successfully")
          EOF
      
      - name: Validate YAML syntax
        run: |
          python - <<'YAML_VALIDATION'
          import yaml
          from pathlib import Path
          
          files_to_check = list(Path('k8s/argo').glob('*.yaml')) + list(Path('k8s').glob('*.yaml'))
          
          for yaml_file in files_to_check:
              print(f"Validating {yaml_file}...")
              try:
                  with open(yaml_file) as f:
                      # Use safe_load_all to handle multi-document YAML files
                      list(yaml.safe_load_all(f))
              except yaml.YAMLError as e:
                  print(f"❌ YAML Error in {yaml_file}:")
                  print(f"   {e}")
                  exit(1)
          
          print("✅ All YAML files validated")
          YAML_VALIDATION
      
      - name: Check for common issues
        run: |
          echo "Checking for hardcoded production namespaces..."
          if grep -r "namespace: production" k8s/ | grep -v "# production only" | grep -q .; then
            echo "⚠️  Warning: Found hardcoded 'namespace: production' - consider using Kustomize overlays"
          fi
          
          echo "Checking for :latest image tags..."
          if grep -r ":latest" k8s/ | grep -v "# latest ok" | grep -q .; then
            echo "⚠️  Warning: Found ':latest' image tags - consider using immutable tags in production"
          fi

  validate-workflow-templates:
    runs-on: ubuntu-latest
    name: Validate Argo WorkflowTemplates
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate WorkflowTemplate YAML syntax
        run: |
          python - <<'TEMPLATE_VALIDATION'
          import yaml
          from pathlib import Path
          
          # Workflow template files
          workflow_files = list(Path('k8s/argo').glob('*workflow*.yaml'))
          
          for yaml_file in workflow_files:
              print(f"Validating {yaml_file}...")
              try:
                  with open(yaml_file) as f:
                      docs = list(yaml.safe_load_all(f))
                      
                      # Validate each document
                      for i, doc in enumerate(docs):
                          if not isinstance(doc, dict):
                              print(f"❌ Document {i+1} is not a valid Kubernetes object")
                              exit(1)
                          
                          # Check required fields
                          if 'apiVersion' not in doc or 'kind' not in doc:
                              print(f"❌ Document {i+1} missing apiVersion or kind")
                              exit(1)
                          
                          kind = doc.get('kind', '')
                          if kind not in ['Workflow', 'WorkflowTemplate', 'CronWorkflow', 'ClusterWorkflowTemplate', 'ServiceAccount', 'Role', 'RoleBinding']:
                              print(f"⚠️  Warning: Unexpected kind '{kind}' in {yaml_file}")
              except yaml.YAMLError as e:
                  print(f"❌ YAML Error in {yaml_file}:")
                  print(f"   {e}")
                  exit(1)
          
          print("✅ All workflow templates validated")
          TEMPLATE_VALIDATION
